import {
  createService,
  InferService,
  ServiceContainer,
} from "@csi-foxbyte/fastify-toab";
import { enhance, Enhanced } from "@zenstackhq/runtime";
import { getAuthService } from "../auth/auth.service.js";
import { PrismaClient } from "@prisma/client";
import realtimeExtension from "./extensions/realtimeExtension.js";

const dbService = createService("db", async ({ services }) => {
  const prisma = new PrismaClient().$extends(
    realtimeExtension({ intervalMs: 5_000 })
  );

  return {
    rawClient: prisma,
    /**
     * Needs to be called within a request context!
     * @returns
     */
    getEnhancedClient() {
      return new Promise<Enhanced<typeof prisma>>(async (resolve, reject) => {
        const authService = await getAuthService(services);

        try {
          const session = await authService.getSession();

          if (!session) throw new Error("Unauthenticated!");

          resolve(enhance(prisma, session));
        } catch (e) {
          return reject(e);
        }
      });
    },
  };
});

/*
AUTOGENERATED!
*/

export { dbService };
export type DbService = InferService<typeof dbService>;
export function getDbService(deps: ServiceContainer) {
  return deps.get<DbService>(dbService.name);
}
